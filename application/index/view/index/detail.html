<!DOCTYPE html>
<html>
<head>
    <title>微评教</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <link rel="stylesheet" href="__CSS__/weui.css">
    <link rel="stylesheet" href="__CSS__/jquery-weui.css">
    <link rel="stylesheet" href="__CSS__/main.css" type="text/css">
    <link rel="stylesheet" href="__CSS__/detail.css" type="text/css">
    <script src="//weixiao.qq.com/js/MTAH5/stats.js" id="WXH5" sid="500439359"></script>
</head>
<body>
<!-- 显示页面 -->
<div id="whole">
    <div class="headimg titlelist">
        <img src="__TEAIMG__/{$basicData.headimg}.png">
        <div class="teaname">{$basicData.name}</div>
    </div>
    <div class="whole">
        <div class="context">
            <p>代表课程：
                {volist name='lessons' id='item'}
                <span >{$item}&nbsp;|</span>
                {/volist}
            </p>
            <p>详细：<span>{$basicData.detail}</span></p>
        </div>
    </div>

    <div class="middle" id="middle" style="display: {$showScore};">
        <div class="weui-slider-box slider" >
            <div class="weui-slider">
                <div  class="weui-slider__inner">
                    <div  style="width: {$basicData.quality}%;" id="nowQuality" class="weui-slider__track"></div>
                </div>
            </div>
            <div  class="weui-slider-box__value" id="_nowQuality">{$basicData.quality}</div>
        </div>
        <div class="score"><span>讲课质量分：</span></div>
        <div class="weui-slider-box slider" >
            <div class="weui-slider">
                <div  class="weui-slider__inner">
                    <div  style="width: {$basicData.responsible}%;" id="nowResponsible" class="weui-slider__track"></div>
                </div>
            </div>
            <div  class="weui-slider-box__value" id="_nowResponsible">{$basicData.responsible}</div>
        </div>
        <div class="score"><span>负责程度值：</span></div>
        <div class="weui-slider-box slider" >
            <div class="weui-slider">
                <div  class="weui-slider__inner">
                    <div style="width: {$basicData.pass}%;" id="nowPass" class="weui-slider__track"></div>
                </div>
            </div>
            <div  class="weui-slider-box__value" id="_nowPass">{$basicData.pass}</div>
        </div>
        <div class="score"><span>难过难易度：</span></div>

    </div>
</div>


<div id="grade" style="display: {$setScore};">
    <div class="weui-slider-box slider" >
        <div class="weui-slider" id="quality">
            <div  class="weui-slider__inner">
                <div style="width: 0%;" class="weui-slider__track"></div>
                <div style="left: 0%;" class="weui-slider__handler"></div>
            </div>
        </div>
        <div  class="weui-slider-box__value" id="qualityCount">0</div>
    </div>
    <div class="score"><span>讲课质量分：</span></div>
    <div class="weui-slider-box slider" >
        <div class="weui-slider" id="responsible">
            <div  class="weui-slider__inner">
                <div style="width: 0%;" class="weui-slider__track"></div>
                <div style="left: 0%;" class="weui-slider__handler"></div>
            </div>
        </div>
        <div  class="weui-slider-box__value" id="responsibleCount">0</div>
    </div>
    <div class="response"><span>负责程度值：</span></div>
    <div class="weui-slider-box slider" >
        <div class="weui-slider" id="pass">
            <div  class="weui-slider__inner">
                <div style="width: 0%;" class="weui-slider__track"></div>
                <div style="left: 0%;" class="weui-slider__handler"></div>
            </div>
        </div>
        <div class="weui-slider-box__value" id="passCount">0</div>
    </div>
    <div class="pass"><span>难过难易度：</span></div>
    <div id="toGrade">
        <p id="gradeBox" onclick="confirm()">评分</p>
    </div>
</div>
<!-- 留言分界线 -->
<div id="addword">
    <div class="topic_reply">
        <p class="reply-count"><span id="commentCount">{$basicData.comcount}</span>条评论</p>
        <div>
            <input placeholder="我也来评论一句" id="comment_box">
        </div>
        <div style="margin-top: 5px">
            <a id="comment_cancel_box" class="comment_cancel" onclick="cleancomment()" clientidmode="Static">取消</a>
            <a id="comment_submit_box" class="comment_submit">评论</a>
        </div>
    </div>
</div>
<!-- 已有留言 -->
<div id="oldword" style="font-size: 14px;">

    <!--<div class="comment">-->
        <!--<div style="float: left;width: 20%;">-->
            <!--<div class="face" style="background-image: url(__HEADIMG__/1.jpg);"></div>-->
        <!--</div>-->
        <!--<div style="float: left;width: 75%;margin-right: 5%">-->
            <!--<div style=""><span class="user_name_style" style="color: #787878">这里没有姐夫</span></div>-->
            <!--<div style=""><span class="context_style">某系主任：我们这个专业毕业生工资在合肥一般也就8000元......</span></div>-->
            <!--<div class="comment_time"><span style="color: #9e9e9e;font-size: 12px;">8小时前</span></div>-->
        <!--</div>-->
    <!--</div>-->

</div>
<div class="weui-loadmore" id="fresh">
    <i class="weui-loading"></i>
    <span class="weui-loadmore__tips">正在加载</span>
</div>
<script type="text/html" id="commentTpl">

    <div class="comment">
        <div style="float: left;width: 20%;">
            <div class="face" style="background-image: url(__HEADIMG__/{0}.jpg);"></div>
        </div>
        <div style="float: left;width: 75%;margin-right: 5%">
            <div style=""><span class="user_name_style" style="color: #787878">{1}</span></div>
            <div style=""><span class="context_style">{2}</span></div>
            <div class="comment_time"><span style="color: #9e9e9e;font-size: 12px;">{3}</span></div>
        </div>
    </div>

</script>
<script src="__JS__/jquery-2.2.4.js"></script>
<script src="__JS__/jquery-weui.js"></script>
<script src="__JS__/public.js"></script>
<script type="text/javascript">
    var isAuth="{$isAuth}",setScoreUrl="{$setScoreUrl}",authUrl="{$authUrl}",tid="{$tid}",art = document.getElementById('comment_cancel_box'),
        stt = document.getElementById('comment_submit_box'),comment="{$comment}",loading = false,page=1,getComment="{$getComment}",oldword=$("#oldword"),
        getCommentCount="{$getCommentCount}";
    init();
    $(window).scroll(function() {
        if((($(window).scrollTop()+$(window).height())+50)>=$(document).height()){
            if(loading == false){
                getData(page,handleData);
                console.log("test");
                loading = true;
            }
        }
    });

    $(function () {
        $("#quality").slider(function (per) {
            $("#qualityCount").html(per)
        });
        $("#responsible").slider(function (per) {
            $("#responsibleCount").html(per)
        });
        $("#pass").slider(function (per) {
            $("#passCount").html(per)
        });
        $("#comment_submit_box").click(function () {
            var commentInput = $.trim($("#comment_box").val());
            if(isWeixin()) {
//                console.log(commentInput);
                $.post(comment,{ tid : tid,comment : commentInput },function (data) {
//                    console.log(data);
                    if(data.status == 1) {
                        $("#commentCount").html(parseInt($("#commentCount").html()) + 1 );
                        oldword.prepend($("#commentTpl").html()._format(data.headimgurl,data.name,commentInput,"刚刚"))
                        $.toast("评论成功");
                    }
                    else {
                        $.toast("评论失败","cancel");
                    }
                })
            }
            else {
                $.alert("请在微信端打开连接！","温馨提示")
            }
            cleancomment();
        });

        $("input").focus(function () {
            $(art).removeClass("comment_cancel");
            $(stt).removeClass("comment_submit");
        });

    });

    function confirm() {
        if(isAuth == "1") {
            var qualityCount = parseInt($("#qualityCount").html()),responsibleCount = parseInt($("#responsibleCount").html()),passCount = parseInt($("#passCount").html());
            if(qualityCount < 0 || responsibleCount < 0 || passCount < 0 || qualityCount > 100 || responsibleCount > 100 || passCount > 100 ) {
                $.alert("分数超过限制","温馨提示");
            }
            $("#grade").css("display","none");
            $.ajax({
                url : setScoreUrl,
                type : "POST",
                data : {tid : window.tid,quality : qualityCount,responsible : responsibleCount,pass : passCount},
                dataType : "JSON",
                success : function (data) {
                    $("#nowQuality").css("width",data.quality+"%");
                    $("#nowResponsible").css("width",data.responsible+"%");
                    $("#nowPass").css("width",data.pass+"%");
                    $("#_nowQuality").html(data.quality);
                    $("#_nowResponsible").html(data.responsible);
                    $("#_nowPass").html(data.pass);
                    $("#middle").css("display","block");
                    console.log(data);
                },
                error : function (e) {
                    console.log(e);
                }
            })
        }
        else {
            if(isWeixin()) {
                window.location.href=authUrl;
            }
            else {
                $.alert("请在微信端打开链接","温馨提示")
            }
        }
    }

    function init() {
        getData(page,handleData);
//        $.post(getCommentCount,{ tid : tid},function (data) {
//            if(data.status == "1") {
//                $("#commentCount").html(data.data);
//            }
//            else {
//                $("#commentCount").html(0);
//            }
//        })
    }

    function getData(page,fn_success) {
        $.ajax({
            url : getComment,
            type : "POST",
            data : { page : page,tid : tid },
            dataType : "JSON",
            success : function (data) {
                fn_success(data);
            },
            error : function () {
                console.log("网络错误，轻稍后再试！")
            }
        })
    }

    function handleData(data) {
        if(data.status == "1") {
            var info = data.data,tpl=$("#commentTpl").html();
            console.log(info);
            for( index in info) {
                oldword.append(tpl._format(info[index].headimgurl,info[index].nickname,info[index].content,info[index].cretime))
            }
            if(info.length == 12) {
                page++;
                loading=false;
            }
            else {
                loading=true;
                $("#fresh").html('<span class="weui-loadmore__tips">-到底了-</span>');
            }
        }
        else {
            console.log("网络不稳定")
        }
    }

    function cleancomment() {
        $(art).addClass("comment_cancel");
        $(stt).addClass("comment_submit");
        document.getElementById('comment_box').value = "";
    }

    function correctWrong() {
        document.getElementById("correctWrong").style.display = "none"
        document.getElementById("submitWrong").style.display = "";
        document.getElementById("wrongClass").style.display = "none";
        document.getElementById("correct_class_box").style.display = "";
        document.getElementById("wrongContact").style.display = "none";
        document.getElementById("correct_contact_box").style.display = "";
    }

    function submitWrong() {
        document.getElementById("correctWrong").style.display = "none"
        document.getElementById("submitWrong").style.display = "none";
        document.getElementById("wrongClass").style.display = "";
        document.getElementById("correct_class_box").style.display = "none";
        document.getElementById("wrongContact").style.display = "";
        document.getElementById("correct_contact_box").style.display = "none";
    }

</script>
</body>
</html>